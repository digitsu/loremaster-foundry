# Build and Release Module
#
# Automatically builds module.zip and attaches it along with module.json
# to GitHub releases when a new release is created.
#
# Usage:
# 1. Go to GitHub Releases
# 2. Create a new release with a tag (e.g., v1.0.0)
# 3. This workflow will automatically attach the module files

name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build (e.g., v1.0.0)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          # Remove 'v' prefix if present
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update version in module.json
        run: |
          # Update version in module.json
          jq --arg version "${{ steps.version.outputs.version }}" \
             '.version = $version' module.json > module.json.tmp
          mv module.json.tmp module.json

          # Add manifest and download URLs if not present
          REPO="${{ github.repository }}"
          jq --arg manifest "https://github.com/$REPO/releases/latest/download/module.json" \
             --arg download "https://github.com/$REPO/releases/latest/download/module.zip" \
             '.manifest = $manifest | .download = $download' module.json > module.json.tmp
          mv module.json.tmp module.json

          echo "Updated module.json:"
          cat module.json

      - name: Create module.zip
        run: |
          # Create zip with only the necessary module files
          # This should match what ends up in the public loremaster-foundry repo
          # Excludes: CLAUDE.md, .claude/, TODO.md, docs/, .DS_Store, .git/, .github/
          zip -r module.zip \
            module.json \
            scripts/ \
            styles/ \
            lang/ \
            templates/ \
            README.md \
            LICENSE.md \
            -x "*.DS_Store" \
            -x "*/.DS_Store" \
            -x "*/__pycache__/*" \
            -x "*.pyc" \
            -x "*.git*" \
            -x "CLAUDE.md" \
            -x ".claude/*" \
            -x "TODO.md" \
            -x "docs/*"

          echo "Created module.zip contents:"
          unzip -l module.zip

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            module.json
            module.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Attached Assets" >> $GITHUB_STEP_SUMMARY
          echo "- \`module.json\` - Module manifest" >> $GITHUB_STEP_SUMMARY
          echo "- \`module.zip\` - Installable module package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manifest URL" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/latest/download/module.json" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
