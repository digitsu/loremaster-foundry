# Publish to Public Repository
#
# Syncs the private loremaster repo to the public loremaster-foundry repo,
# excluding private/internal files like CLAUDE.md, TODO.md, and docs/.
#
# Required setup:
# 1. Create the public repo: digitsu/loremaster-foundry
# 2. Create a Personal Access Token (PAT) with 'repo' scope
# 3. Add the PAT as a secret named PUBLIC_REPO_TOKEN in this repo's settings

name: Publish to Public Repo

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Remove private files
        run: |
          # Remove Claude-related files
          rm -rf CLAUDE.md
          rm -rf .claude/

          # Remove internal docs and TODO
          rm -rf TODO.md
          rm -rf docs/

          # Remove macOS metadata files
          find . -name ".DS_Store" -type f -delete

          # Remove this workflow from public repo (keeps public repo clean)
          # But keep release.yml for building releases
          rm -rf .github/workflows/publish-public.yml

          echo "Removed private/system files:"
          echo "  - CLAUDE.md"
          echo "  - .claude/"
          echo "  - TODO.md"
          echo "  - docs/"
          echo "  - .DS_Store (all)"
          echo "  - .github/workflows/publish-public.yml"
          echo ""
          echo "Kept in public repo:"
          echo "  - .github/workflows/release.yml"

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Commit file removals
        run: |
          # Commit the private file deletions so working tree is clean
          # (required before git filter-branch can run)
          git add -A
          git diff --staged --quiet || git commit -m "Remove private files for public repo"

      - name: Scrub AI attribution from commit messages
        run: |
          # Remove Co-Authored-By lines and Claude Code generated lines from all commits
          FILTER_BRANCH_SQUELCH_WARNING=1 git filter-branch --msg-filter '
            sed "/^Co-Authored-By:.*$/d" | sed "/.*Generated with \[Claude Code\].*/d"
          ' --force -- --all
          rm -rf .git/refs/original

      - name: Push to public repo
        run: |

          # Push directly with token in URL
          git push --force "https://x-access-token:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/digitsu/loremaster-foundry.git" main

          echo "Successfully published to digitsu/loremaster-foundry"

      - name: Create release on public repo
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          BODY="${{ github.event.release.body }}"

          # Check if release already exists on public repo
          if gh release view "$TAG" --repo digitsu/loremaster-foundry > /dev/null 2>&1; then
            echo "Release $TAG already exists on public repo, skipping"
            exit 0
          fi

          # Create the release on the public repo
          # The release.yml workflow on the public repo will handle building assets
          gh release create "$TAG" \
            --repo digitsu/loremaster-foundry \
            --title "$TAG" \
            --notes "${BODY:-Release $TAG}"

          echo "Created release $TAG on digitsu/loremaster-foundry"
