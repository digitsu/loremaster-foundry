# Shared Content UI Implementation Progress

## Session 1 - 2026-02-08

### Completed: US-0 - Socket Client Wrapper Methods for Shared Content

**Files Changed:**
- scripts/socket-client.mjs (added 160 lines)

**What Was Done:**
1. Added 6 user-facing wrapper methods for shared content operations:
   - listSharedContent() - Lists available shared content for current game system
   - activateSharedContent(sharedContentId) - Activates shared content (subject to tier limits)
   - deactivateSharedContent(sharedContentId) - Deactivates shared content
   - getSharedTierStatus() - Gets tier info and activation limits
   - getSharedContentDetail(sharedContentId) - Gets detailed info for a shared content item
   - submitToSharedLibrary(contentType, contentId, publisher, description) - Submits content for review

2. Added 5 admin-only wrapper methods:
   - adminListPendingShared() - Lists pending submissions
   - adminApproveShared(sharedContentId) - Approves a pending submission
   - adminRejectShared(sharedContentId) - Rejects a pending submission
   - adminPublishPdf(pdfId, options) - Directly publishes a PDF (bypasses approval)
   - adminRemoveShared(sharedContentId) - Removes published shared content

**Key Learnings:**
- The socket-client.mjs uses _sendRequest() as the standard pattern for all request/response operations
- _sendRequest() automatically handles both Phoenix Channels and Node.js WebSocket protocols
- Admin methods should check this.isGM and throw appropriate errors
- All methods need JSDoc documentation following the established pattern
- Methods are organized into logical sections with comment headers (// ===== Section Name =====)
- The _sendRequest() method handles timeout, pending request tracking, and protocol switching automatically

**Acceptance Criteria Met:**
✅ All 6 user wrapper methods exist with JSDoc documentation
✅ All 5 admin wrapper methods exist with JSDoc documentation
✅ Methods follow existing patterns using _sendRequest()
✅ Proper error handling with _requireAuth() and GM checks
✅ CamelCase payload keys used throughout

**Next Steps:**
The next priority story is US-1 (Documents Tab Separation and Read-Only Shared Tiles), which will:
- Split PDFs tab into "Your Documents" and "Shared Library" sections
- Add browse modal for available shared content
- Implement read-only tiles for activated shared content
- Add category filtering

---

## Session 2 - 2026-02-08 (continued)

### Completed: US-1 - Documents Tab Separation and Read-Only Shared Tiles

**Files Changed:**
- scripts/content-manager.mjs (added ~210 lines)
- templates/content-manager.hbs (added ~50 lines)
- styles/loremaster.css (added ~340 lines)

**What Was Done:**

1. **Updated ContentManager constructor** to initialize shared content properties:
   - this.sharedContent = []
   - this.sharedTier = null
   - this.activatedSharedContent = []

2. **Added _loadSharedContentData() method** that:
   - Calls socketClient.listSharedContent() to get available shared content
   - Calls socketClient.getSharedTierStatus() to get tier limits
   - Filters activated items into this.activatedSharedContent
   - Handles errors gracefully (non-critical)

3. **Updated _render() method** to load shared content data on first render (alongside PDFs)

4. **Updated getData() method** to return:
   - sharedContent - all available shared content
   - sharedTier - tier status with current/max counts
   - activatedSharedContent - filtered activated items
   - hasActivatedSharedContent - boolean flag

5. **Added event listeners** in activateListeners():
   - .browse-shared-btn → opens browse dialog
   - .deactivate-shared-btn → deactivates shared content

6. **Implemented _onBrowseSharedLibrary() handler** that:
   - Creates a Foundry Dialog with card grid layout
   - Shows tier status (n/m activated or n/∞ for premium)
   - Category filter buttons (All, Core Rules, Adventure, etc.)
   - Each card shows: title, publisher, category, type icon, description
   - Activate/Deactivate buttons with tier limit enforcement
   - Empty state for no content
   - Filter functionality to show/hide cards by category
   - Auto-refresh after activate/deactivate operations

7. **Implemented _onDeactivateSharedContent() handler** that:
   - Shows confirmation dialog
   - Calls socketClient.deactivateSharedContent()
   - Refreshes data on success
   - Shows appropriate notifications

8. **Modified content-manager.hbs template**:
   - Added "Your Documents" section header above existing PDF list
   - Added "Shared Library" section after PDF list (conditional on hasActivatedSharedContent)
   - Shared Library header shows tier status (n/m activated)
   - Shared tiles use .shared-content-tile class with:
     - fa-cloud icon (instead of fa-file-pdf)
     - Blue "Shared" badge
     - Publisher name
     - Category and content type
     - Only "Deactivate" button (no delete, GM Prep, or share)
   - Added "Browse Shared Library" button at bottom

9. **Added comprehensive CSS styles**:
   - .documents-section-header - "Your Documents" header
   - .shared-library-section - container for shared content
   - .shared-section-header - "Shared Library" header with blue styling
   - .shared-tier-count - tier status text in header
   - .shared-content-tile - blue-tinted tiles with subtle border
   - .shared-icon - blue cloud icon
   - .shared-badge - gradient blue/purple badge
   - .browse-shared-btn - prominent gradient button
   - .shared-tier-status - tier info box in dialog
   - .shared-category-filters - filter button row
   - .shared-category-filter - individual filter buttons with active state
   - .shared-library-grid - responsive card grid (auto-fill minmax 300px)
   - .shared-content-card - individual cards with hover effects
   - .card-header/.card-body/.card-footer - card sections
   - .category-badge - category labels
   - .activate-card-btn/.deactivate-card-btn - action buttons

**Key Learnings:**
- Foundry Dialog class is used for modal overlays, not custom HTML/CSS overlays
- jQuery event binding pattern: html.find('.selector').on('click', handler)
- Template conditionals use {{#if}} with Handlebars helpers
- CSS grid with auto-fill/minmax creates responsive card layouts
- Tier limit of -1 means unlimited (premium tier)
- Backend listSharedContent returns {content: [], tier: {current, max}}
- game.system.title provides the current game system name
- Non-critical errors (like failed shared content load) should be logged but not shown to users

**Acceptance Criteria Met:**
✅ PDFs tab shows 'Your Documents' section header above existing PDF list
✅ PDFs tab shows 'Shared Library' section with activated shared content tiles
✅ Shared Library section header shows tier status (n/m activated)
✅ Shared Library section only appears when user has activated items
✅ 'Browse Shared Library' button opens a modal overlay with available content
✅ Browse panel shows content as card tiles with title, publisher, category, type icon, description
✅ Browse panel has category filter and tier status display
✅ Only content for current game.system.id is shown (backend filters by system)
✅ Empty state message when no shared content exists
✅ Activated shared tiles use fa-cloud icon and have blue/purple 'Shared' badge
✅ Shared tiles have NO delete, GM Prep, or share buttons
✅ Shared tiles have a 'Deactivate' button
✅ Shared tiles have visual distinction (blue border/tint)
✅ CSS styles added for .shared-library-grid, .shared-content-tile, browse panel

**Next Steps:**
The next priority story is US-5 (Login Window Shared Content Counter), which will:
- Add a "Shared Resources" row to the Patreon login window
- Show activation count vs tier limit with visual indicators
- Add [Manage] link that opens Content Manager
- Fetch tier status during _fetchQuota() in patreon-login-ui.mjs
- Add Handlebars helper 'sharedTierLevel'

---

## Session 3 - 2026-02-08 (continued)

### Completed: US-5 - Login Window Shared Content Counter

**Files Changed:**
- scripts/patreon-login-ui.mjs (added ~60 lines)
- templates/patreon-login.hbs (added ~80 lines)

**What Was Done:**

1. **Added shared tier state to PatreonLoginUI constructor:**
   - this.sharedTier = null

2. **Implemented _fetchSharedTierStatus() method:**
   - Called alongside _fetchRagStatus() during _fetchQuota()
   - Gets socket client from game.loremaster
   - Calls socketClient.getSharedTierStatus()
   - Stores result in this.sharedTier
   - Re-renders on success
   - Gracefully handles errors

3. **Updated getData() to return shared tier data:**
   - sharedTier - full tier object
   - sharedTierCurrent - current activation count
   - sharedTierMax - max activations (-1 for unlimited)
   - sharedTierName - tier name (free/basic/pro/premium)
   - sharedTierUnlimited - boolean flag for unlimited

4. **Added _onManageSharedContent() handler:**
   - Opens Content Manager via game.loremaster.openContentManager()
   - Shows warning if Content Manager not available
   - Bound to .manage-shared-link click event

5. **Registered sharedTierLevel Handlebars helper:**
   - Returns 'none' for max === 0 (free tier)
   - Returns 'available' for max === -1 (unlimited) or current < max
   - Returns 'at-limit' for current >= max

6. **Updated patreon-login.hbs template:**
   - Added Shared Resources section after RAG status, before quota
   - Three display formats:
     - Normal tiers: "n / m activated" with [Manage] link
     - Premium tier: "n activated (unlimited)" with [Manage] link
     - Free tier: "Upgrade to access" with Patreon subscribe link
   - Uses sharedTierLevel helper to apply color class

7. **Added CSS styles in template:**
   - .patreon-shared-resources - container with flex layout
   - .shared-available - green background/border for under limit
   - .shared-at-limit - yellow/warning background/border for at limit
   - .shared-none - grey background/border for free tier
   - .shared-icon - book emoji
   - .shared-text - "Shared Resources:" label
   - .shared-count - activation count display
   - .manage-shared-link - golden link with hover effect

**Key Learnings:**
- getData() provides all data to template via return object
- Handlebars helpers registered in registerPatreonLoginHelpers() function
- Template styles are inline in <style> block at bottom of .hbs file
- Socket client accessed via game.modules.get('loremaster').api.getSocketClient()
- Color-coded status indicators follow existing RAG status pattern
- [Manage] link uses same styling as Patreon subscribe link

**Acceptance Criteria Met:**
✅ Shared Resources row appears in login window after RAG status, before quota
✅ Shows 'n / m activated' format for basic/pro tiers
✅ Shows 'n activated (unlimited)' for premium tier
✅ Shows 'Upgrade to access' with Patreon link for free tier
✅ Green indicator when under limit, yellow at limit, grey for free tier
✅ [Manage] link opens Content Manager
✅ Data fetched via getSharedTierStatus() during _fetchQuota()
✅ Handlebars helper sharedTierLevel registered in loremaster.mjs

**Next Steps:**
The next priority story is US-2 (Submit Content for Sharing), which will:
- Add a "Share" button to completed PDF tiles in "Your Documents"
- Clicking opens a confirmation dialog with title, publisher, description fields
- Submit calls submitToSharedLibrary() socket method
- Handle success, already-exists, and error cases with appropriate notifications

---

## Session 4 - 2026-02-08 (continued)

### Completed: US-2 - Submit Content for Sharing

**Files Changed:**
- templates/content-manager.hbs (added 7 lines)
- scripts/content-manager.mjs (added 96 lines)
- styles/loremaster.css (added 14 lines)

**What Was Done:**

1. **Added Share button to content-manager.hbs template:**
   - Button appears in .pdf-actions div next to delete button
   - Only visible for PDFs with processing_status === "completed"
   - Uses fa-share-alt icon
   - data-pdf-id and data-pdf-name attributes for handler
   - Title: "Share to Library"

2. **Added event listener in activateListeners():**
   - html.find('.share-pdf-btn').on('click', this._onSharePDF.bind(this))
   - Added after delete button listener, before GM Prep listener

3. **Implemented _onSharePDF() handler:**
   - Extracts pdfId and pdfName from event.currentTarget.dataset
   - Opens Foundry Dialog with form containing:
     - Title field (pre-filled with pdfName, read-only, grey background)
     - Publisher field (optional text input)
     - Description field (optional textarea, 4 rows)
   - Inline CSS styles for form layout
   - Submit button: "Submit for Review" with fa-share-alt icon
   - Cancel button with fa-times icon
   - On submit callback:
     - Calls this.socketClient.submitToSharedLibrary('pdf', pdfId, publisher, description)
     - Success: Shows "Submitted for review" notification
     - Success: Disables share button, sets title to "Pending Review", opacity 0.5
     - Error handling:
       - Checks if error message includes "already exists" → ui.notifications.warn
       - Otherwise → ui.notifications.error with error message
     - Console.error logs full error

4. **Added CSS styles:**
   - .share-pdf-btn - blue theme (#4a90e2 border/color)
   - Hover state - fills background with blue, white text
   - Disabled state - opacity 0.5, cursor not-allowed
   - Follows same pattern as .delete-pdf-btn (red theme)

**Key Learnings:**
- Foundry Dialog buttons can have async callbacks
- Dialog content can include inline <style> tags for custom form styling
- event.currentTarget preserves the clicked button for post-submit manipulation
- Read-only input fields styled with background: #f5f5f5 for visual distinction
- Error messages can be checked with .includes() to handle specific cases
- Share button should only appear for completed PDFs (not processing, failed, etc.)

**Acceptance Criteria Met:**
✅ Share button (fa-share-alt) appears on completed PDF tiles next to delete button
✅ Share button NOT shown for PDFs with non-completed processing status
✅ Clicking Share opens confirmation dialog with title, publisher, description fields
✅ Title field pre-filled from PDF display_name (read-only)
✅ Submit calls submitToSharedLibrary with correct params ('pdf', pdfId, publisher, description)
✅ Success shows 'Submitted for review' notification and disables button
✅ Already-exists case shows appropriate notification (ui.notifications.warn)
✅ Error handling with user-friendly messages via ui.notifications

**Next Steps:**
The next priority story is US-4 (Shared Adventures on Active Adventure Tab), which will:
- Add activated shared adventures to the adventure selector dropdown
- Add third optgroup "Shared Adventures" after PDF and Module groups
- Filter shared content for adventure/adventure_supplement categories
- When selected, call setActiveAdventure('shared', sharedContentId)
- Show "Shared" badge for active shared adventures
- Hide GM Prep and delete buttons for shared adventures
- Verify backend support for adventure_type: 'shared'
