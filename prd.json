{
  "project": "loremaster",
  "branchName": "ralph/p2-polish",
  "description": "Finish remaining P2 polish items for the Loremaster Foundry module: (1) Add i18n keys for all shared content UI strings and the inline settings account panel, then wire them up in templates and JS; (2) Add a persistent status header bar showing connection state, tier, and quota at a glance.",
  "userStories": [
    {
      "id": "US-0",
      "title": "Add i18n Keys to lang/en.json",
      "description": "Add all missing i18n keys to lang/en.json for: shared content UI (content-manager.hbs and content-manager.mjs), Patreon login UI (patreon-login.hbs and patreon-login-ui.mjs), inline settings account panel (config.mjs), and connection status bar (new). Do NOT modify any JS or HBS files in this story — only update lang/en.json.\n\nNew key groups to add under LOREMASTER:\n\n1. SharedContent — strings from content-manager.hbs and content-manager.mjs:\n   - YourDocuments, SharedLibrary, ShareToLibrary, SharedBadge, PublisherPrefix (\"by\"), Active, Deactivate, DeactivateTitle, BrowseLibrary, SharedAdventure, SharedAdventures, ManageSharedContent, Admin\n   - ShareDialogTitle, TitleLabel, PublisherLabel, PublisherPlaceholder, DescriptionLabel, DescriptionPlaceholder, Submit, Cancel, PendingReview, SubmittedSuccess\n   - BrowseDialogTitle (\"Shared Library — {system}\"), TierStatus (\"{current} / {max} shared resources activated\"), TierUnlimited, ActivateBtn, DeactivateBtn, CloseBtn, ActivateSuccess, DeactivateSuccess, AtLimitError (\"At activation limit ({max}). Deactivate a resource to activate another.\"), DeactivateDialogTitle, DeactivateConfirm (\"Deactivate <strong>{title}</strong>?\"), DeactivateHint\n\n2. PatreonLogin — strings from patreon-login.hbs and patreon-login-ui.mjs:\n   - ConnectAccount, SignInHint, SignInBtn, Or, PasteTokenBtn, NoSubscription, SubscribeLink\n   - SigningIn, SigningInHint, PopupBlockedHint\n   - Connected, RAGEnabled, RAGLocked, RAGRequiresTier (\"Requires {tier} tier\")\n   - SharedResources, ActivatedUnlimited (\"{count} activated (unlimited)\"), ManageLink, UpgradeAccess, ActivatedCount (\"{current} / {max} activated\")\n   - MonthlyUsage, ResetsDate (\"Resets: {date}\"), TokensPerMonth (\"tokens/month\"), SignOut\n   - AuthFailed, TryAgain\n   - SignOutDialogTitle, SignOutConfirm\n   - SessionTokenLabel, SessionTokenPlaceholder, SessionTokenHint, EnterTokenTitle, ConnectBtn\n   - ConnectedSuccess, InvalidToken (\"Invalid token — {reason}\"), ValidationFailed\n   - ContentManagerUnavailable\n\n3. Connection — strings for the status header bar:\n   - Connecting, Connected, Disconnected, Reconnecting, ReconnectAttempt (\"Reconnecting ({attempt}/{max})...\"), SessionExpired, NotConnected\n\n4. SettingsPanel — strings for section headers in settings:\n   - AccountSection, ConnectionSection, ChatSection, ContextSection, MultiPlayerSection, UsageSection",
      "acceptanceCriteria": [
        "lang/en.json contains LOREMASTER.SharedContent group with all shared content UI strings",
        "lang/en.json contains LOREMASTER.PatreonLogin group with all login/account UI strings",
        "lang/en.json contains LOREMASTER.Connection group with connection status strings",
        "lang/en.json contains LOREMASTER.SettingsPanel group with section header strings",
        "All parameterized strings use {param} placeholder format consistent with existing keys",
        "No JS or HBS files are modified in this story",
        "JSON is valid and well-formatted"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed: Added 92 i18n keys across 4 groups (SharedContent: 39, PatreonLogin: 38, Connection: 9, SettingsPanel: 6). JSON validated."
    },
    {
      "id": "US-1",
      "title": "Wire i18n Keys in Shared Content UI",
      "description": "Replace hardcoded English strings in the shared content sections of content-manager.hbs and content-manager.mjs with game.i18n.localize() / game.i18n.format() calls using the keys added in US-0.\n\nFiles to modify:\n\n1. templates/content-manager.hbs:\n   - Replace 'Your Documents' → {{localize 'LOREMASTER.SharedContent.YourDocuments'}}\n   - Replace 'Shared Library' → {{localize 'LOREMASTER.SharedContent.SharedLibrary'}}\n   - Replace 'Share to Library' → {{localize 'LOREMASTER.SharedContent.ShareToLibrary'}}\n   - Replace 'Shared' badge → {{localize 'LOREMASTER.SharedContent.SharedBadge'}}\n   - Replace 'by' prefix → {{localize 'LOREMASTER.SharedContent.PublisherPrefix'}}\n   - Replace 'Active' badge → {{localize 'LOREMASTER.SharedContent.Active'}}\n   - Replace 'Deactivate this shared content' → {{localize 'LOREMASTER.SharedContent.DeactivateTitle'}}\n   - Replace 'Browse Shared Library' → {{localize 'LOREMASTER.SharedContent.BrowseLibrary'}}\n   - Replace 'Shared Adventure' → {{localize 'LOREMASTER.SharedContent.SharedAdventure'}}\n   - Replace 'Shared Adventures' → {{localize 'LOREMASTER.SharedContent.SharedAdventures'}}\n   - Replace 'Manage Shared Content' → {{localize 'LOREMASTER.SharedContent.ManageSharedContent'}}\n   - Replace 'Admin' → {{localize 'LOREMASTER.SharedContent.Admin'}}\n\n2. scripts/content-manager.mjs:\n   - Share dialog: Replace hardcoded strings with game.i18n.localize/format calls\n   - Browse dialog: Replace title, button labels, tier status text, notifications\n   - Deactivate dialog: Replace title, confirm text, notifications\n   - Use game.i18n.format() for parameterized strings like '{current} / {max} shared resources activated'\n   - Keep fallback || patterns for safety: game.i18n?.localize('KEY') || 'fallback'\n\nIMPORTANT: Only touch shared content strings. Do NOT change existing localized strings or non-shared-content strings.",
      "acceptanceCriteria": [
        "All 12+ hardcoded strings in content-manager.hbs replaced with {{localize}} calls",
        "All hardcoded strings in content-manager.mjs share/browse/deactivate dialogs replaced with game.i18n calls",
        "Parameterized strings use game.i18n.format() with correct parameter names",
        "Fallback || patterns used for safety in JS code",
        "No non-shared-content strings are modified",
        "Template renders correctly (no broken Handlebars syntax)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Completed: 13 hardcoded strings in content-manager.hbs replaced with {{localize}} calls. All share/browse/deactivate dialog strings in content-manager.mjs replaced with game.i18n calls using fallback || patterns. Parameterized strings use game.i18n.format()."
    },
    {
      "id": "US-2",
      "title": "Wire i18n Keys in Patreon Login UI and Settings Account Panel",
      "description": "Replace hardcoded English strings in patreon-login.hbs, patreon-login-ui.mjs, and the inline account panel in config.mjs with i18n calls.\n\nFiles to modify:\n\n1. templates/patreon-login.hbs:\n   - Replace all hardcoded text with {{localize 'LOREMASTER.PatreonLogin.X'}} calls\n   - Key mappings: 'Connect Your Account' → ConnectAccount, 'Sign in with Patreon' → SignInBtn, 'or' → Or, 'Paste Token Manually' → PasteTokenBtn, etc.\n   - For shared resources section: use PatreonLogin keys (SharedResources, ActivatedUnlimited, ManageLink, UpgradeAccess, ActivatedCount)\n   - 'Connected' → Connected, 'Advanced RAG Enabled' → RAGEnabled, 'Monthly Usage' → MonthlyUsage, 'Sign Out' → SignOut, etc.\n\n2. scripts/patreon-login-ui.mjs:\n   - Sign out dialog: Replace title/content strings with game.i18n.localize calls\n   - Paste token dialog: Replace all labels, placeholders, and button text\n   - Notification messages: Replace with game.i18n.localize/format calls\n   - Keep fallback || patterns for safety\n\n3. scripts/config.mjs (inline account panel):\n   - In _buildLoggedOutPanel(): Replace hardcoded text with game.i18n?.localize calls\n   - In _buildLoggingInPanel(): Same treatment\n   - In _buildLoggedInPanel(): Replace all status/tier/quota/shared resource text\n   - In _buildErrorPanel(): Replace error state text\n   - In _handleSignOut(): Replace dialog title/content\n   - In _handlePasteToken(): Replace dialog strings\n   - In _insertSectionHeaders(): Replace section labels with game.i18n calls using SettingsPanel keys\n   - Section headers: 'Account' → SettingsPanel.AccountSection, 'Connection' → SettingsPanel.ConnectionSection, etc.\n\nIMPORTANT: The patreon-login.hbs template uses Handlebars {{localize}} helper. The JS files (patreon-login-ui.mjs, config.mjs) use game.i18n.localize() / game.i18n.format().",
      "acceptanceCriteria": [
        "All hardcoded strings in patreon-login.hbs replaced with {{localize}} calls",
        "All hardcoded strings in patreon-login-ui.mjs dialogs/notifications replaced with game.i18n calls",
        "All hardcoded strings in config.mjs account panel builders and section headers replaced with game.i18n calls",
        "Section header labels use LOREMASTER.SettingsPanel keys",
        "Parameterized strings use game.i18n.format() with correct parameters",
        "Fallback || patterns used in JS for safety",
        "No functional behavior changes — only string source changes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Completed: All hardcoded strings in patreon-login.hbs (4 states), patreon-login-ui.mjs (dialogs + notifications), and config.mjs (4 panel builders + section headers + dialogs) replaced with i18n calls. Parameterized strings use format(). Fallback || patterns throughout."
    },
    {
      "id": "US-3",
      "title": "Connection Status Header Bar Component",
      "description": "Create a persistent, compact status bar that shows Loremaster's connection state at a glance. This bar appears below the Foundry navigation/scene bar and above the canvas area. It is always visible while Loremaster is enabled, providing instant feedback about server connectivity.\n\nNew file: scripts/status-bar.mjs\n\nClass: StatusBar\n- Follows the same pattern as ProgressBar and BatchUI: creates a DOM element in initialize(), toggles visibility/state with methods\n- Singleton instance exported as `statusBar`\n\nDOM structure:\n```html\n<div id=\"loremaster-status-bar\" class=\"loremaster-status-bar loremaster-status--connected\">\n  <div class=\"loremaster-status-content\">\n    <i class=\"fas fa-hat-wizard loremaster-status-icon\"></i>\n    <span class=\"loremaster-status-label\">Loremaster</span>\n    <span class=\"loremaster-status-state\">Connected</span>\n    <span class=\"loremaster-status-detail\">Pro · 1.2M / 2M tokens</span>\n  </div>\n</div>\n```\n\nStates (each has a CSS class and icon):\n- connected: Green dot, shows tier + quota summary (e.g., 'Pro · 1.2M / 2M'). Auto-collapses to just the icon after 5 seconds.\n- connecting: Yellow spinner, 'Connecting...'\n- disconnected: Red dot, 'Disconnected'\n- reconnecting: Yellow spinner, 'Reconnecting ({attempt}/{max})...'\n- auth-required: Orange lock icon, 'Sign in required' — clicking opens settings\n- disabled: Grey, 'Disabled' (when module is off)\n\nPositioning:\n- Fixed position below the top Foundry nav bar (#navigation)\n- Left-aligned, compact pill shape\n- z-index below dialogs but above canvas\n- Subtle, non-intrusive — small font, muted colors, transparent background\n\nAuto-collapse behavior:\n- After connection is stable for 5 seconds, collapse to just the wizard hat icon (hover to expand)\n- While disconnected/reconnecting/auth-required, stay expanded\n- Click the bar to expand/collapse manually\n\nIntegration points (in loremaster.mjs):\n- Import and initialize statusBar in the 'ready' hook (after progressBar.initialize())\n- After successful initializeLoremaster(): call statusBar.setConnected(tierName, tokensUsed, tokensLimit)\n- In showPatreonLoginPrompt(): call statusBar.setAuthRequired()\n- Wire socketClient events:\n  - On disconnect: statusBar.setDisconnected()\n  - On reconnect attempt: statusBar.setReconnecting(attempt, max)\n  - On reconnect success: statusBar.setConnected(...)\n  - On auth required: statusBar.setAuthRequired()\n- When module is disabled (enabled=false): statusBar.setDisabled()\n- Click handler on auth-required state: open game.settings.sheet.render(true)\n\nCSS (inline in the module, same pattern as progress-bar.mjs):\n- Use Foundry CSS variables for theming\n- Smooth transitions for state changes\n- Collapse/expand animation\n- All classes prefixed with loremaster-status-\n\ni18n: Use the LOREMASTER.Connection keys added in US-0 for all status text.\n\nIMPORTANT: The status bar only needs to read `game.loremaster.socketClient.isConnected` and auth manager state — it does NOT manage connections itself. It's purely a display component.",
      "acceptanceCriteria": [
        "New scripts/status-bar.mjs file with StatusBar class and singleton export",
        "StatusBar creates a persistent DOM element below Foundry's nav bar",
        "All 6 states render correctly: connected, connecting, disconnected, reconnecting, auth-required, disabled",
        "Connected state shows tier and quota summary",
        "Auto-collapse after 5 seconds in connected state",
        "Click to expand/collapse toggle",
        "Click in auth-required state opens Foundry settings",
        "i18n keys used for all displayed text with fallback patterns",
        "CSS styles use Foundry CSS variables and loremaster-status- prefix",
        "StatusBar initialized in loremaster.mjs ready hook",
        "StatusBar state updated at all connection lifecycle points in loremaster.mjs",
        "StatusBar state updated in socket-client.mjs disconnect/reconnect handlers",
        "No functional changes to existing connection logic — display only"
      ],
      "priority": 4
    }
  ]
}
