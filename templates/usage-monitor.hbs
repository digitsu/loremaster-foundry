{{!--
  Loremaster Usage Monitor Template

  Template for the Usage Monitor Application window.
  Displays API usage statistics with horizontal progress bars.
--}}
<div class="usage-monitor-container">
  {{#if isLoading}}
    <div class="loading-overlay">
      <i class="fas fa-spinner fa-spin"></i>
      <span>{{localize "LOREMASTER.UsageMonitor.Loading"}}</span>
    </div>
  {{else if stats}}
    {{!-- All-Time Usage Section --}}
    <section class="usage-section">
      <h3 class="section-header">
        <i class="fas fa-history"></i>
        {{localize "LOREMASTER.UsageMonitor.AllTimeUsage"}}
      </h3>

      <div class="usage-main">
        <div class="usage-label">
          <span class="usage-title">{{localize "LOREMASTER.UsageMonitor.TokensUsed"}}</span>
          <span class="usage-values">
            {{formatNumber stats.allTime.totalTokens}}
            {{#if hasTokenLimit}}
              / {{formatNumber maxTokensPerMonth}}
            {{/if}}
          </span>
        </div>

        {{#if hasTokenLimit}}
          <div class="usage-bar-container">
            <div class="usage-bar {{usageLevel stats.allTime.totalTokens maxTokensPerMonth}}"
                 style="width: {{barWidth stats.allTime.totalTokens maxTokensPerMonth}}%"></div>
          </div>
          <div class="usage-percent">
            {{formatPercent stats.allTime.totalTokens maxTokensPerMonth}}
          </div>
        {{else}}
          <div class="usage-no-limit">
            {{localize "LOREMASTER.UsageMonitor.NoLimitConfigured"}}
          </div>
        {{/if}}
      </div>

      <div class="usage-breakdown">
        <div class="breakdown-item">
          <span class="breakdown-label">{{localize "LOREMASTER.UsageMonitor.InputTokens"}}</span>
          <span class="breakdown-value">{{formatNumber stats.allTime.inputTokens}}</span>
        </div>
        <div class="breakdown-item">
          <span class="breakdown-label">{{localize "LOREMASTER.UsageMonitor.OutputTokens"}}</span>
          <span class="breakdown-value">{{formatNumber stats.allTime.outputTokens}}</span>
        </div>
        <div class="breakdown-item">
          <span class="breakdown-label">{{localize "LOREMASTER.UsageMonitor.TotalRequests"}}</span>
          <span class="breakdown-value">{{formatNumber stats.allTime.requestCount}}</span>
        </div>
      </div>
    </section>

    {{!-- Session Usage Section (Trip Meter) --}}
    <section class="usage-section session-section">
      <h3 class="section-header">
        <i class="fas fa-stopwatch"></i>
        {{localize "LOREMASTER.UsageMonitor.SessionUsage"}}
        {{#if isGM}}
          <button type="button" class="reset-session-btn" title="{{localize 'LOREMASTER.UsageMonitor.ResetSession'}}">
            <i class="fas fa-redo"></i>
            {{localize "LOREMASTER.UsageMonitor.Reset"}}
          </button>
        {{/if}}
      </h3>

      <div class="session-info">
        <span class="session-started">
          <i class="fas fa-clock"></i>
          {{#if stats.session.sessionStart}}
            {{localize "LOREMASTER.UsageMonitor.SessionStarted"}}: {{formatDateTime stats.session.sessionStart}}
          {{else}}
            {{localize "LOREMASTER.UsageMonitor.NoActiveSession"}}
          {{/if}}
        </span>
      </div>

      <div class="usage-main">
        <div class="usage-label">
          <span class="usage-title">{{localize "LOREMASTER.UsageMonitor.TokensThisSession"}}</span>
          <span class="usage-values session-tokens">
            {{formatNumber stats.session.totalTokens}}
          </span>
        </div>

        {{!-- Session progress bar (relative to configured limit) --}}
        {{#if hasTokenLimit}}
          <div class="usage-bar-container session-bar">
            <div class="usage-bar {{usageLevel stats.session.totalTokens maxTokensPerMonth}}"
                 style="width: {{barWidth stats.session.totalTokens maxTokensPerMonth}}%"></div>
          </div>
        {{/if}}
      </div>

      <div class="usage-breakdown">
        <div class="breakdown-item">
          <span class="breakdown-label">{{localize "LOREMASTER.UsageMonitor.InputTokens"}}</span>
          <span class="breakdown-value">{{formatNumber stats.session.inputTokens}}</span>
        </div>
        <div class="breakdown-item">
          <span class="breakdown-label">{{localize "LOREMASTER.UsageMonitor.OutputTokens"}}</span>
          <span class="breakdown-value">{{formatNumber stats.session.outputTokens}}</span>
        </div>
        <div class="breakdown-item">
          <span class="breakdown-label">{{localize "LOREMASTER.UsageMonitor.TotalRequests"}}</span>
          <span class="breakdown-value">{{formatNumber stats.session.requestCount}}</span>
        </div>
      </div>
    </section>

    {{!-- Prompt Caching Section --}}
    {{#if (or stats.allTime.cacheReadTokens stats.allTime.cacheCreationTokens)}}
      <section class="usage-section cache-section">
        <h3 class="section-header">
          <i class="fas fa-bolt"></i>
          {{localize "LOREMASTER.UsageMonitor.CacheTitle"}}
        </h3>

        <div class="cache-summary">
          <div class="cache-stat cache-read">
            <i class="fas fa-check-circle"></i>
            <span class="cache-label">{{localize "LOREMASTER.UsageMonitor.CacheRead"}}</span>
            <span class="cache-value">{{formatNumber stats.allTime.cacheReadTokens}}</span>
          </div>
          <div class="cache-stat cache-creation">
            <i class="fas fa-plus-circle"></i>
            <span class="cache-label">{{localize "LOREMASTER.UsageMonitor.CacheCreation"}}</span>
            <span class="cache-value">{{formatNumber stats.allTime.cacheCreationTokens}}</span>
          </div>
        </div>

        {{#if stats.allTime.cacheReadTokens}}
          <div class="cache-savings">
            <i class="fas fa-piggy-bank"></i>
            <span>{{localize "LOREMASTER.UsageMonitor.CacheSavings"}}: ~{{formatNumber (mult stats.allTime.cacheReadTokens 0.9)}} tokens (90% of cached reads)</span>
          </div>
        {{/if}}

        <div class="cache-efficiency">
          <span class="efficiency-label">{{localize "LOREMASTER.UsageMonitor.CacheHitRate"}}</span>
          <span class="efficiency-value">{{cacheHitRate stats.allTime.cacheReadTokens stats.allTime.cacheCreationTokens stats.allTime.inputTokens}}</span>
        </div>
      </section>
    {{/if}}

    {{!-- Usage By Feature Type --}}
    {{#if stats.byType.length}}
      <section class="usage-section">
        <h3 class="section-header">
          <i class="fas fa-chart-pie"></i>
          {{localize "LOREMASTER.UsageMonitor.UsageByType"}}
        </h3>

        <ul class="usage-by-type">
          {{#each stats.byType}}
            <li class="type-item">
              <span class="type-name">{{requestTypeLabel request_type}}</span>
              <span class="type-stats">
                <span class="type-tokens">{{formatNumber total_tokens}} tokens</span>
                <span class="type-requests">({{formatNumber request_count}} requests)</span>
              </span>
            </li>
          {{/each}}
        </ul>
      </section>
    {{/if}}

    {{!-- Refresh Button --}}
    <footer class="usage-footer">
      <button type="button" class="refresh-btn">
        <i class="fas fa-sync-alt"></i>
        {{localize "LOREMASTER.UsageMonitor.Refresh"}}
      </button>
    </footer>
  {{else}}
    <div class="no-data">
      <i class="fas fa-chart-bar"></i>
      <p>{{localize "LOREMASTER.UsageMonitor.NoData"}}</p>
      <button type="button" class="refresh-btn">
        <i class="fas fa-sync-alt"></i>
        {{localize "LOREMASTER.UsageMonitor.Refresh"}}
      </button>
    </div>
  {{/if}}
</div>
