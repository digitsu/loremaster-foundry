{{!--
  Loremaster Content Manager Template

  Template for the Content Manager Application window.
  Allows GMs to upload and manage PDF adventure content.
--}}
<div class="content-manager-container">
  {{!-- Header with stats --}}
  <header class="content-manager-header">
    <div class="stats-summary">
      {{!-- License Status --}}
      {{#if license}}
        <span class="stat-item license-status {{#if license.isValid}}license-valid{{else}}license-invalid{{/if}}"
              title="{{#if license.isValid}}License: {{license.tier}}{{#if license.holderEmail}} ({{license.holderEmail}}){{/if}}{{else}}No valid license{{/if}}">
          <i class="fas {{#if license.isValid}}fa-key{{else}}fa-exclamation-triangle{{/if}}"></i>
          {{#if license.isValid}}
            {{license.tier}}
          {{else}}
            Unlicensed
          {{/if}}
        </span>
      {{/if}}
      {{#if stats}}
        <span class="stat-item" title="{{localize 'LOREMASTER.ContentManager.Stats.Total'}}">
          <i class="fas fa-file-pdf"></i> {{stats.total}}
        </span>
        <span class="stat-item status-completed" title="{{localize 'LOREMASTER.ContentManager.Stats.Completed'}}">
          <i class="fas fa-check-circle"></i> {{stats.completed}}
        </span>
        {{#if stats.processing}}
          <span class="stat-item status-processing" title="{{localize 'LOREMASTER.ContentManager.Stats.Processing'}}">
            <i class="fas fa-spinner fa-spin"></i> {{stats.processing}}
          </span>
        {{/if}}
        {{#if stats.failed}}
          <span class="stat-item status-failed" title="{{localize 'LOREMASTER.ContentManager.Stats.Failed'}}">
            <i class="fas fa-exclamation-circle"></i> {{stats.failed}}
          </span>
        {{/if}}
      {{/if}}
    </div>
    <div class="header-actions">
      {{#if isAdmin}}
        <button type="button" class="admin-shared-btn" title="Manage Shared Content">
          <i class="fas fa-shield-alt"></i> Admin
        </button>
      {{/if}}
      {{#if isGM}}
        <button type="button" class="generate-embeddings-btn" title="{{localize 'LOREMASTER.ContentManager.GenerateEmbeddings'}}">
          <i class="fas fa-brain"></i>
        </button>
      {{/if}}
      <button type="button" class="refresh-btn" title="{{localize 'LOREMASTER.ContentManager.Refresh'}}">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </header>

  {{!-- Tab Navigation --}}
  <nav class="tabs">
    <a class="item" data-tab="pdfs">
      <i class="fas fa-file-pdf"></i> {{localize "LOREMASTER.ContentManager.Tab.PDFs"}}
    </a>
    <a class="item" data-tab="upload">
      <i class="fas fa-upload"></i> {{localize "LOREMASTER.ContentManager.Tab.Upload"}}
    </a>
    {{#if isGM}}
      <a class="item" data-tab="adventure">
        <i class="fas fa-dragon"></i> {{localize "LOREMASTER.ContentManager.Tab.Adventure"}}
      </a>
      <a class="item" data-tab="cast">
        <i class="fas fa-users"></i> {{localize "LOREMASTER.Cast.TabLabel"}}
      </a>
      <a class="item" data-tab="history">
        <i class="fas fa-history"></i> {{localize "LOREMASTER.History.TabLabel"}}
      </a>
      <a class="item" data-tab="backup">
        <i class="fas fa-box-archive"></i> {{localize "LOREMASTER.Backup.TabLabel"}}
      </a>
    {{/if}}
  </nav>

  {{!-- Tab Content --}}
  <section class="content">
    {{!-- PDFs List Tab --}}
    <div class="tab" data-tab="pdfs">
      {{!-- Your Documents Section --}}
      <h3 class="documents-section-header">Your Documents</h3>
      {{#if pdfs.length}}
        <ul class="pdf-list">
          {{#each pdfs}}
            <li class="pdf-item {{statusClass processing_status}}">
              <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
              </div>
              <div class="pdf-info">
                <div class="pdf-name">
                  {{display_name}}
                  <span class="pdf-id-badge" title="Use 'pdf:{{id}}' for /lm commands">pdf:{{id}}</span>
                  {{#if hasGMPrepScript}}
                    {{#if (eq gmPrepStatus "completed")}}
                      <span class="gm-script-tag gm-script-ready">
                        <i class="fas fa-check"></i> {{localize "LOREMASTER.GMPrep.ScriptReady"}}
                      </span>
                    {{else if (eq gmPrepStatus "generating")}}
                      <span class="gm-script-tag gm-script-generating">
                        <i class="fas fa-spinner fa-spin"></i> {{localize "LOREMASTER.GMPrep.ScriptGenerating"}}
                      </span>
                    {{else if (eq gmPrepStatus "failed")}}
                      <span class="gm-script-tag gm-script-failed">
                        <i class="fas fa-exclamation-triangle"></i> {{localize "LOREMASTER.GMPrep.ScriptFailed"}}
                      </span>
                    {{/if}}
                  {{/if}}
                </div>
                <div class="pdf-meta">
                  <span class="pdf-category">{{categoryLabel category}}</span>
                  <span class="pdf-size">{{formatSize original_size}}</span>
                  {{#if extracted_text_length}}
                    <span class="pdf-extracted">{{formatSize extracted_text_length}} extracted</span>
                  {{/if}}
                </div>
                <div class="pdf-status">
                  <span class="status-badge {{statusClass processing_status}}">
                    {{statusLabel processing_status}}
                  </span>
                  {{#if error_message}}
                    <span class="error-message" title="{{error_message}}">
                      <i class="fas fa-info-circle"></i>
                    </span>
                  {{/if}}
                </div>
              </div>
              <div class="pdf-actions">
                {{!-- GM Prep button for adventure PDFs (GM only) --}}
                {{#if ../isGM}}
                  {{#if (eq category "adventure")}}
                    {{#if claude_file_id}}
                      <button type="button" class="gm-prep-btn {{#if hasGMPrepScript}}has-script{{/if}}"
                              data-pdf-id="{{id}}"
                              data-pdf-name="{{display_name}}"
                              data-has-script="{{hasGMPrepScript}}"
                              title="{{#if hasGMPrepScript}}{{localize 'LOREMASTER.GMPrep.Regenerate'}}{{else}}{{localize 'LOREMASTER.GMPrep.Generate'}}{{/if}}">
                        <i class="fas {{#if hasGMPrepScript}}fa-sync{{else}}fa-wand-magic-sparkles{{/if}}"></i>
                      </button>
                    {{else}}
                      <button type="button" class="gm-prep-btn disabled" disabled
                              title="{{localize 'LOREMASTER.GMPrep.ReuploadRequired'}}">
                        <i class="fas fa-exclamation-triangle"></i>
                      </button>
                    {{/if}}
                  {{/if}}
                {{/if}}
                {{!-- Share button for completed PDFs --}}
                {{#if (eq processing_status "completed")}}
                  <button type="button" class="share-pdf-btn"
                          data-pdf-id="{{id}}"
                          data-pdf-name="{{display_name}}"
                          title="Share to Library">
                    <i class="fas fa-share-alt"></i>
                  </button>
                {{/if}}
                <button type="button" class="delete-pdf-btn" data-pdf-id="{{id}}" data-pdf-name="{{display_name}}"
                        title="{{localize 'LOREMASTER.ContentManager.Delete'}}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          {{/each}}
        </ul>
      {{else}}
        <div class="empty-state">
          <i class="fas fa-file-pdf"></i>
          <p>{{localize "LOREMASTER.ContentManager.Empty"}}</p>
          <p class="empty-hint">{{localize "LOREMASTER.ContentManager.EmptyHint"}}</p>
        </div>
      {{/if}}

      {{!-- Shared Library Section --}}
      {{#if hasActivatedSharedContent}}
        <div class="shared-library-section">
          <h3 class="shared-section-header">
            Shared Library
            {{#if sharedTier}}
              <span class="shared-tier-count">({{sharedTier.current}} / {{#if (eq sharedTier.max -1)}}âˆž{{else}}{{sharedTier.max}}{{/if}} activated)</span>
            {{/if}}
          </h3>
          <ul class="shared-content-list">
            {{#each activatedSharedContent}}
              <li class="shared-content-tile">
                <div class="pdf-icon shared-icon">
                  <i class="fas fa-cloud"></i>
                </div>
                <div class="pdf-info">
                  <div class="pdf-name">
                    {{this.title}}
                    <span class="shared-badge">Shared</span>
                  </div>
                  <div class="pdf-meta">
                    <span class="pdf-category">{{categoryLabel this.category}}</span>
                    <span class="pdf-publisher">by {{this.publisher}}</span>
                    <span class="pdf-content-type">{{this.contentType}}</span>
                  </div>
                  <div class="pdf-status">
                    <span class="status-badge status-completed">Active</span>
                  </div>
                </div>
                <div class="pdf-actions">
                  <button type="button" class="deactivate-shared-btn"
                          data-shared-id="{{this.id}}"
                          data-shared-title="{{this.title}}"
                          title="Deactivate this shared content">
                    <i class="fas fa-times-circle"></i>
                  </button>
                </div>
              </li>
            {{/each}}
          </ul>
        </div>
      {{/if}}

      {{!-- Browse Shared Library Button --}}
      <div class="browse-shared-section">
        <button type="button" class="browse-shared-btn">
          <i class="fas fa-globe"></i> Browse Shared Library
        </button>
      </div>
    </div>

    {{!-- Upload Tab --}}
    <div class="tab" data-tab="upload">
      {{#if isGM}}
        <form class="upload-form">
          {{!-- Drop Zone --}}
          <div class="upload-zone">
            <div class="upload-zone-content">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>{{localize "LOREMASTER.ContentManager.DropZone"}}</p>
              <p class="upload-hint">{{localize "LOREMASTER.ContentManager.DropZoneHint"}} (max {{maxFileSize}})</p>
              <button type="button" class="browse-btn">
                <i class="fas fa-folder-open"></i> {{localize "LOREMASTER.ContentManager.Browse"}}
              </button>
            </div>
            <input type="file" class="file-input hidden" accept=".pdf,application/pdf">
          </div>

          {{!-- Selected File Info --}}
          <div class="selected-file-info hidden">
            <div class="selected-file">
              <i class="fas fa-file-pdf"></i>
              <span class="selected-file-name"></span>
              <span class="selected-file-size"></span>
            </div>
          </div>

          {{!-- Upload Options --}}
          <div class="upload-options">
            <div class="form-group">
              <label for="display-name">{{localize "LOREMASTER.ContentManager.DisplayName"}}</label>
              <input type="text" id="display-name" class="display-name-input"
                     placeholder="{{localize 'LOREMASTER.ContentManager.DisplayNamePlaceholder'}}">
            </div>

            <div class="form-group">
              <label for="category">{{localize "LOREMASTER.ContentManager.CategoryLabel"}}</label>
              <select id="category" class="category-select">
                {{#each categories}}
                  <option value="{{value}}">{{label}}</option>
                {{/each}}
              </select>
            </div>
          </div>

          {{!-- Upload Progress --}}
          <div class="upload-progress hidden">
            <div class="progress-bar">
              <div class="progress-bar-fill" style="width: 0%"></div>
            </div>
            <div class="progress-info">
              <span class="progress-message">{{localize "LOREMASTER.ContentManager.Uploading"}}</span>
              <span class="progress-percent">0%</span>
            </div>
          </div>

          {{!-- Upload Button --}}
          <button type="button" class="upload-btn" disabled>
            <i class="fas fa-upload"></i> {{localize "LOREMASTER.ContentManager.UploadBtn"}}
          </button>
        </form>

        {{!-- Foundry Module Import Section --}}
        <div class="foundry-module-import-section">
          <hr class="section-divider">
          <h3>{{localize "LOREMASTER.ModuleImport.Title"}}</h3>
          <p class="hint">{{localize "LOREMASTER.ModuleImport.Hint"}}</p>

          {{#if foundryModulesAvailable}}
            {{!-- Module List --}}
            <div class="foundry-module-list">
              {{#each foundryModules}}
                <div class="foundry-module-item {{this.importStatus}}">
                  <div class="module-icon">
                    <i class="fas fa-cube"></i>
                  </div>
                  <div class="module-info">
                    <div class="module-name">{{this.name}}</div>
                    <div class="module-meta">
                      <span class="module-id">{{this.id}}</span>
                      {{#if this.version}}
                        <span class="module-version">v{{this.version}}</span>
                      {{/if}}
                      {{#if this.chunkCount}}
                        <span class="module-chunks">{{this.chunkCount}} chunks</span>
                      {{/if}}
                    </div>
                    {{#if this.importStatus}}
                      <div class="module-status">
                        <span class="import-status-badge {{this.importStatus}}">
                          {{#if (eq this.importStatus "completed")}}
                            <i class="fas fa-check-circle"></i> {{localize "LOREMASTER.ModuleImport.Status.Imported"}}
                          {{else if (eq this.importStatus "importing")}}
                            <i class="fas fa-spinner fa-spin"></i> {{localize "LOREMASTER.ModuleImport.Status.Importing"}}
                          {{else if (eq this.importStatus "failed")}}
                            <i class="fas fa-exclamation-circle"></i> {{localize "LOREMASTER.ModuleImport.Status.Failed"}}
                          {{else}}
                            <i class="fas fa-clock"></i> {{localize "LOREMASTER.ModuleImport.Status.NotImported"}}
                          {{/if}}
                        </span>
                      </div>
                    {{/if}}
                  </div>
                  <div class="module-actions">
                    {{#if (eq this.importStatus "completed")}}
                      <button type="button" class="delete-module-btn"
                              data-module-id="{{this.id}}"
                              data-module-name="{{this.name}}"
                              title="{{localize 'LOREMASTER.ModuleImport.Delete'}}">
                        <i class="fas fa-trash"></i>
                      </button>
                    {{else if (eq this.importStatus "importing")}}
                      <button type="button" class="import-module-btn" disabled>
                        <i class="fas fa-spinner fa-spin"></i>
                      </button>
                    {{else}}
                      <button type="button" class="import-module-btn"
                              data-module-id="{{this.id}}"
                              data-module-name="{{this.name}}"
                              title="{{localize 'LOREMASTER.ModuleImport.Import'}}">
                        <i class="fas fa-download"></i> {{localize "LOREMASTER.ModuleImport.Import"}}
                      </button>
                    {{/if}}
                  </div>
                </div>
              {{/each}}
            </div>

            {{!-- Import Progress --}}
            <div class="module-import-progress hidden">
              <div class="progress-bar">
                <div class="progress-bar-fill" style="width: 0%"></div>
              </div>
              <div class="progress-info">
                <span class="progress-message">{{localize "LOREMASTER.ModuleImport.Importing"}}...</span>
                <span class="progress-percent">0%</span>
              </div>
            </div>
          {{else}}
            <div class="no-modules-state">
              <i class="fas fa-cube"></i>
              <p>{{localize "LOREMASTER.ModuleImport.NoModules"}}</p>
              <p class="hint">{{localize "LOREMASTER.ModuleImport.NoModulesHint"}}</p>
            </div>
          {{/if}}

          {{!-- Refresh Button --}}
          <button type="button" class="refresh-modules-btn">
            <i class="fas fa-sync-alt"></i> {{localize "LOREMASTER.ModuleImport.Refresh"}}
          </button>
        </div>
      {{else}}
        <div class="permission-notice">
          <i class="fas fa-lock"></i>
          <p>{{localize "LOREMASTER.ContentManager.GMOnly"}}</p>
        </div>
      {{/if}}
    </div>

    {{!-- Active Adventure Tab --}}
    <div class="tab" data-tab="adventure">
      {{#if isGM}}
        <div class="active-adventure-panel">
          {{!-- Current Adventure Display --}}
          <div class="current-adventure-section">
            <h3>{{localize "LOREMASTER.ActiveAdventure.CurrentTitle"}}</h3>

            {{#if activeAdventure}}
              <div class="current-adventure-card">
                <div class="adventure-icon">
                  {{#if (eq activeAdventure.adventure_type "pdf")}}
                    <i class="fas fa-file-pdf"></i>
                  {{else if (eq activeAdventure.adventure_type "shared")}}
                    <i class="fas fa-cloud"></i>
                  {{else}}
                    <i class="fas fa-cube"></i>
                  {{/if}}
                </div>
                <div class="adventure-details">
                  <div class="adventure-name">
                    {{activeAdventure.adventure_name}}
                    {{#if (eq activeAdventure.adventure_type "pdf")}}
                      <span class="pdf-id-badge" title="Use 'pdf:{{activeAdventure.pdf_id}}' for /lm commands">pdf:{{activeAdventure.pdf_id}}</span>
                    {{else if (eq activeAdventure.adventure_type "shared")}}
                      <span class="shared-badge">Shared</span>
                    {{else}}
                      <span class="module-id-badge" title="Use '{{activeAdventure.module_id}}' for /lm commands">{{activeAdventure.module_id}}</span>
                    {{/if}}
                  </div>
                  <div class="adventure-type-badge">
                    {{#if (eq activeAdventure.adventure_type "pdf")}}
                      {{localize "LOREMASTER.ActiveAdventure.TypePDF"}}
                    {{else if (eq activeAdventure.adventure_type "shared")}}
                      Shared Adventure
                    {{else}}
                      {{localize "LOREMASTER.ActiveAdventure.TypeModule"}}
                    {{/if}}
                  </div>
                  {{#if linkedGMPrepScript}}
                    {{#if (ne activeAdventure.adventure_type "shared")}}
                      <div class="gm-prep-link">
                        <span class="gm-prep-status gm-prep-ready">
                          <i class="fas fa-check"></i> {{localize "LOREMASTER.GMPrep.ScriptReady"}}
                        </span>
                        <button type="button" class="view-gm-prep-btn" data-script-id="{{linkedGMPrepScript.id}}">
                          <i class="fas fa-eye"></i> {{localize "LOREMASTER.ActiveAdventure.ViewScript"}}
                        </button>
                      </div>
                    {{/if}}
                  {{/if}}
                </div>
                <button type="button" class="clear-adventure-btn" title="{{localize 'LOREMASTER.ActiveAdventure.Clear'}}">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              {{!-- Transition State --}}
              {{#if transitionState}}
                {{#if (ne transitionState.state "none")}}
                  <div class="transition-status">
                    <i class="fas fa-exchange-alt"></i>
                    {{localize "LOREMASTER.ActiveAdventure.TransitionInProgress"}}
                    <span class="transition-from">{{transitionState.fromName}}</span>
                    <button type="button" class="complete-transition-btn">
                      <i class="fas fa-check"></i> {{localize "LOREMASTER.ActiveAdventure.CompleteTransition"}}
                    </button>
                  </div>
                {{/if}}
              {{/if}}
            {{else}}
              <div class="no-adventure-selected">
                <i class="fas fa-map-signs"></i>
                <p>{{localize "LOREMASTER.ActiveAdventure.NoSelection"}}</p>
                <p class="hint">{{localize "LOREMASTER.ActiveAdventure.NoSelectionHint"}}</p>
              </div>
            {{/if}}
          </div>

          {{!-- Adventure Selector --}}
          <div class="adventure-selector-section">
            <h3>{{localize "LOREMASTER.ActiveAdventure.SelectTitle"}}</h3>

            <select class="adventure-select">
              <option value="">{{localize "LOREMASTER.ActiveAdventure.SelectPlaceholder"}}</option>

              {{#if availableAdventures.pdfAdventures.length}}
                <optgroup label="{{localize 'LOREMASTER.ActiveAdventure.PDFAdventures'}}">
                  {{#each availableAdventures.pdfAdventures}}
                    <option value="pdf:{{this.id}}"
                      {{#if (eq ../activeAdventure.adventure_type "pdf")}}
                        {{#if (eq ../activeAdventure.pdf_id this.id)}}selected{{/if}}
                      {{/if}}>
                      {{this.display_name}}{{#if this.hasGMPrepScript}} [GM Script]{{/if}}
                    </option>
                  {{/each}}
                </optgroup>
              {{/if}}

              {{#if availableAdventures.moduleAdventures.length}}
                <optgroup label="{{localize 'LOREMASTER.ActiveAdventure.ModuleAdventures'}}">
                  {{#each availableAdventures.moduleAdventures}}
                    <option value="module:{{this.module_id}}"
                      {{#if (eq ../activeAdventure.adventure_type "module")}}
                        {{#if (eq ../activeAdventure.module_id this.module_id)}}selected{{/if}}
                      {{/if}}>
                      {{this.module_name}}
                    </option>
                  {{/each}}
                </optgroup>
              {{/if}}

              {{#if sharedAdventures.length}}
                <optgroup label="Shared Adventures">
                  {{#each sharedAdventures}}
                    <option value="shared:{{this.id}}"
                      {{#if (eq ../activeAdventure.adventure_type "shared")}}
                        {{#if (eq ../activeAdventure.shared_content_id this.id)}}selected{{/if}}
                      {{/if}}>
                      {{this.title}} ({{this.publisher}})
                    </option>
                  {{/each}}
                </optgroup>
              {{/if}}
            </select>
          </div>

          {{!-- Register Foundry Module Section --}}
          <div class="register-module-section">
            <h3>{{localize "LOREMASTER.ActiveAdventure.RegisterModuleTitle"}}</h3>
            <p class="hint">{{localize "LOREMASTER.ActiveAdventure.RegisterModuleHint"}}</p>

            <div class="module-registration">
              <select class="foundry-module-select">
                <option value="">{{localize "LOREMASTER.ActiveAdventure.SelectModule"}}</option>
              </select>
              <button type="button" class="register-module-btn" disabled>
                <i class="fas fa-plus"></i> {{localize "LOREMASTER.ActiveAdventure.Register"}}
              </button>
            </div>

            {{#if availableAdventures.moduleAdventures.length}}
              <div class="registered-modules-list">
                <h4>{{localize "LOREMASTER.ActiveAdventure.RegisteredModules"}}</h4>
                <ul>
                  {{#each availableAdventures.moduleAdventures}}
                    <li>
                      <span class="module-name">{{this.module_name}}</span>
                      <span class="module-id-badge" title="Use '{{this.module_id}}' for /lm commands">{{this.module_id}}</span>
                      <button type="button" class="unregister-module-btn" data-module-id="{{this.module_id}}">
                        <i class="fas fa-trash"></i>
                      </button>
                    </li>
                  {{/each}}
                </ul>
              </div>
            {{/if}}
          </div>
        </div>
      {{else}}
        <div class="permission-notice">
          <i class="fas fa-lock"></i>
          <p>{{localize "LOREMASTER.ActiveAdventure.GMOnly"}}</p>
        </div>
      {{/if}}
    </div>

    {{!-- Cast Management Tab --}}
    <div class="tab" data-tab="cast">
      {{#if isGM}}
        <div class="cast-panel">
          {{#if castScriptId}}
            {{!-- Character List --}}
            <div class="cast-header">
              <h3>{{localize "LOREMASTER.Cast.Title"}}</h3>
              <div class="cast-actions-header">
                <button type="button" class="extract-characters-btn" title="{{localize 'LOREMASTER.Cast.ExtractFromScript'}}">
                  <i class="fas fa-sync"></i> {{localize "LOREMASTER.Cast.ExtractFromScript"}}
                </button>
                <button type="button" class="save-cast-btn" title="{{localize 'LOREMASTER.Cast.SaveAssignments'}}">
                  <i class="fas fa-save"></i> {{localize "LOREMASTER.Cast.SaveAssignments"}}
                </button>
              </div>
            </div>

            {{#if castCharacters.length}}
              <div class="cast-list">
                {{#each castCharacters}}
                  <div class="cast-character {{this.characterRole}}" data-character-name="{{this.characterName}}">
                    <div class="character-info">
                      <div class="character-name">
                        {{this.characterName}}
                        {{#if this.isPlayable}}
                          <span class="playable-badge" title="{{localize 'LOREMASTER.Cast.Playable'}}">
                            <i class="fas fa-user"></i>
                          </span>
                        {{/if}}
                      </div>
                      <div class="character-role">{{this.characterRole}}</div>
                      {{#if this.personalitySummary}}
                        <div class="character-personality">{{this.personalitySummary}}</div>
                      {{/if}}
                    </div>
                    <div class="character-assignment">
                      <div class="assignment-row">
                        <label>{{localize "LOREMASTER.Cast.AssignTo"}}</label>
                        <select class="assign-player-select" data-character="{{this.characterName}}">
                          <option value="">{{localize "LOREMASTER.Cast.Unassigned"}}</option>
                          {{#each ../gamePlayers}}
                            <option value="{{this.id}}"
                              {{#if (eq this.id ../this.assignedToUserId)}}selected{{/if}}>
                              {{this.name}}{{#if this.isGM}} (GM){{/if}}
                            </option>
                          {{/each}}
                        </select>
                      </div>
                      <div class="control-row">
                        <label class="control-checkbox">
                          <input type="checkbox" class="gm-control-checkbox"
                                 data-character="{{this.characterName}}"
                                 {{#if this.isGMControlled}}checked{{/if}}>
                          <span>{{localize "LOREMASTER.Cast.GMControls"}}</span>
                        </label>
                        <label class="control-checkbox">
                          <input type="checkbox" class="ai-control-checkbox"
                                 data-character="{{this.characterName}}"
                                 {{#if this.isLoremasterControlled}}checked{{/if}}>
                          <span>{{localize "LOREMASTER.Cast.AIControls"}}</span>
                        </label>
                      </div>
                    </div>
                  </div>
                {{/each}}
              </div>
            {{else}}
              <div class="empty-cast-state">
                <i class="fas fa-users-slash"></i>
                {{#if hasNonPlayableOnly}}
                  <p>{{localize "LOREMASTER.Cast.NoPlayableCharacters"}}</p>
                  <p class="hint">{{localize "LOREMASTER.Cast.NoPlayableCharactersHint"}}</p>
                {{else}}
                  <p>{{localize "LOREMASTER.Cast.NoCharacters"}}</p>
                  <p class="hint">{{localize "LOREMASTER.Cast.NoCharactersHint"}}</p>
                {{/if}}
                <button type="button" class="extract-characters-btn">
                  <i class="fas fa-wand-magic-sparkles"></i> {{localize "LOREMASTER.Cast.ExtractFromScript"}}
                </button>
              </div>
            {{/if}}
          {{else}}
            {{!-- No active adventure with GM Prep script --}}
            <div class="no-cast-state">
              <i class="fas fa-map-signs"></i>
              <p>{{localize "LOREMASTER.Cast.NoActiveAdventure"}}</p>
              <p class="hint">{{localize "LOREMASTER.Cast.NoActiveAdventureHint"}}</p>
            </div>
          {{/if}}
        </div>
      {{else}}
        <div class="permission-notice">
          <i class="fas fa-lock"></i>
          <p>{{localize "LOREMASTER.Cast.GMOnly"}}</p>
        </div>
      {{/if}}
    </div>

    {{!-- History Tab --}}
    <div class="tab" data-tab="history">
      {{#if isGM}}
        <div class="history-panel">
          {{!-- Active Conversation Section --}}
          <div class="active-conversation-section">
            <div class="section-header">
              <h3>{{localize "LOREMASTER.History.ActiveConversation"}}</h3>
              <button type="button" class="refresh-history-btn" title="Refresh">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>

            {{#if activeConversation}}
              <div class="conversation-card active-conversation">
                <div class="conversation-icon">
                  <i class="fas fa-comments"></i>
                </div>
                <div class="conversation-details">
                  <div class="conversation-title">
                    {{#if activeConversation.title}}
                      {{activeConversation.title}}
                    {{else}}
                      {{localize "LOREMASTER.ConversationManager.Untitled"}}
                    {{/if}}
                  </div>
                  <div class="conversation-meta">
                    <span class="message-count">
                      <i class="fas fa-comment"></i>
                      {{activeConversation.message_count}} messages
                    </span>
                    {{#if activeConversation.total_tokens}}
                      <span class="token-count">
                        <i class="fas fa-coins"></i>
                        {{activeConversation.total_tokens}} tokens
                      </span>
                    {{/if}}
                  </div>
                </div>
                <div class="conversation-actions">
                  <button type="button" class="compact-conversation-btn"
                          {{#if isCompacting}}disabled{{/if}}
                          title="{{localize 'LOREMASTER.History.CompactBtn'}}">
                    {{#if isCompacting}}
                      <i class="fas fa-spinner fa-spin"></i>
                    {{else}}
                      <i class="fas fa-compress-alt"></i>
                    {{/if}}
                    {{localize "LOREMASTER.History.CompactBtn"}}
                  </button>
                </div>
              </div>
            {{else}}
              <div class="no-conversation-state">
                <i class="fas fa-comment-slash"></i>
                <p>{{localize "LOREMASTER.History.NoActive"}}</p>
                <p class="hint">{{localize "LOREMASTER.History.NoActiveHint"}}</p>
              </div>
            {{/if}}
          </div>

          {{!-- Archived Conversations Section --}}
          <div class="archived-conversations-section">
            <h3>{{localize "LOREMASTER.History.ArchivedConversations"}}</h3>

            {{#if compactedConversations.length}}
              <ul class="compacted-conversation-list">
                {{#each compactedConversations}}
                  <li class="conversation-card compacted-conversation">
                    <div class="conversation-icon">
                      <i class="fas fa-archive"></i>
                    </div>
                    <div class="conversation-details">
                      <div class="conversation-title">
                        {{#if this.title}}
                          {{this.title}}
                        {{else}}
                          {{localize "LOREMASTER.ConversationManager.Untitled"}}
                        {{/if}}
                      </div>
                      <div class="conversation-meta">
                        <span class="archived-date">
                          <i class="fas fa-calendar"></i>
                          {{this.compacted_at}}
                        </span>
                        {{#if this.summary_tokens}}
                          <span class="summary-tokens">
                            <i class="fas fa-file-alt"></i>
                            {{this.summary_tokens}} token summary
                          </span>
                        {{/if}}
                      </div>
                    </div>
                    <div class="conversation-actions">
                      <button type="button" class="view-summary-btn"
                              data-conversation-id="{{this.id}}"
                              data-conversation-title="{{this.title}}"
                              title="{{localize 'LOREMASTER.History.ViewSummary'}}">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button type="button" class="continue-adventure-btn"
                              data-conversation-id="{{this.id}}"
                              data-conversation-title="{{this.title}}"
                              title="{{localize 'LOREMASTER.History.ContinueAdventure'}}">
                        <i class="fas fa-play"></i>
                        {{localize "LOREMASTER.History.ContinueAdventure"}}
                      </button>
                    </div>
                  </li>
                {{/each}}
              </ul>
            {{else}}
              <div class="no-archived-state">
                <i class="fas fa-folder-open"></i>
                <p>{{localize "LOREMASTER.History.NoCompacted"}}</p>
              </div>
            {{/if}}
          </div>
        </div>
      {{else}}
        <div class="permission-notice">
          <i class="fas fa-lock"></i>
          <p>{{localize "LOREMASTER.History.GMOnly"}}</p>
        </div>
      {{/if}}
    </div>

    {{!-- Backup Tab (GM Only) --}}
    <div class="tab backup-tab" data-tab="backup">
      {{#if isGM}}
        <div class="backup-panel">
          {{!-- Export Section --}}
          <section class="backup-section export-section">
            <h3><i class="fas fa-download"></i> {{localize "LOREMASTER.Backup.ExportTitle"}}</h3>
            <p class="section-description">
              {{localize "LOREMASTER.Backup.ExportDescription"}}
            </p>

            {{#if backupPreview}}
              <div class="backup-preview">
                <h4>{{localize "LOREMASTER.Backup.DataToExport"}}</h4>
                <ul class="preview-list">
                  <li><i class="fas fa-scroll"></i> {{backupPreview.canonCount}} {{localize "LOREMASTER.Backup.CanonEntries"}}</li>
                  <li><i class="fas fa-gavel"></i> {{backupPreview.houseRulesCount}} {{localize "LOREMASTER.Backup.HouseRules"}}</li>
                  <li><i class="fas fa-book"></i> {{backupPreview.scriptsCount}} {{localize "LOREMASTER.Backup.GMPrepScripts"}}</li>
                  <li><i class="fas fa-users"></i> {{backupPreview.characterCount}} {{localize "LOREMASTER.Backup.CharacterAssignments"}}</li>
                  <li><i class="fas fa-flag-checkered"></i> {{backupPreview.progressCount}} {{localize "LOREMASTER.Backup.CampaignProgress"}}</li>
                  <li><i class="fas fa-comments"></i> {{backupPreview.summaryCount}} {{localize "LOREMASTER.Backup.ConversationSummaries"}}</li>
                </ul>
                <p class="preview-note">
                  <i class="fas fa-info-circle"></i>
                  {{localize "LOREMASTER.Backup.NotIncludedNote"}}
                </p>
              </div>
            {{else}}
              <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>{{localize "LOREMASTER.Backup.LoadingPreview"}}</p>
              </div>
            {{/if}}

            <div class="backup-controls">
              <div class="backup-name-row">
                <label for="backup-name">{{localize "LOREMASTER.Backup.NamePlaceholder"}}</label>
                <input type="text" id="backup-name" class="backup-name-input"
                       placeholder="{{worldName}} Backup - {{currentDate}}"
                       value="{{worldName}} Backup - {{currentDate}}">
              </div>
              <div class="backup-button-row">
                <button class="create-backup-btn" {{#if isBackingUp}}disabled{{/if}}>
                  {{#if isHostedMode}}
                    <i class="fas fa-save"></i>
                    {{#if isBackingUp}}
                      {{localize "LOREMASTER.Backup.Creating"}}
                    {{else}}
                      {{localize "LOREMASTER.Backup.CreateBackup"}}
                    {{/if}}
                  {{else}}
                    <i class="fas fa-download"></i>
                    {{#if isBackingUp}}
                      {{localize "LOREMASTER.Backup.Creating"}}
                    {{else}}
                      {{localize "LOREMASTER.Backup.CreateDownload"}}
                    {{/if}}
                  {{/if}}
                </button>
              </div>
            </div>

            {{#if isBackingUp}}
              <div class="progress-container backup-progress">
                <div class="progress-bar backup-progress-bar" style="width: {{backupProgress.progress}}%"></div>
                <span class="progress-text backup-progress-text">{{backupProgress.message}}</span>
              </div>
            {{/if}}
          </section>

          {{!-- Saved Backups Section (Hosted Mode Only) --}}
          {{#if isHostedMode}}
            <section class="backup-section saved-backups-section">
              <h3><i class="fas fa-server"></i> {{localize "LOREMASTER.Backup.SavedBackupsTitle"}}</h3>
              <p class="section-description">
                {{localize "LOREMASTER.Backup.SavedBackupsDescription"}}
              </p>

              {{#if savedBackups.length}}
                <ul class="saved-backups-list">
                  {{#each savedBackups}}
                    <li class="saved-backup-item">
                      <div class="backup-info">
                        <div class="backup-name">{{this.name}}</div>
                        <div class="backup-meta">
                          <span class="backup-date">
                            <i class="fas fa-calendar"></i> {{this.createdAt}}
                          </span>
                          <span class="backup-size">
                            <i class="fas fa-database"></i> {{formatSize this.sizeBytes}}
                          </span>
                          {{#if this.stats}}
                            <span class="backup-stats" title="{{this.stats.conversations}} conversations, {{this.stats.messages}} messages">
                              <i class="fas fa-comments"></i> {{this.stats.conversations}}
                            </span>
                          {{/if}}
                        </div>
                        {{#if this.description}}
                          <div class="backup-description">{{this.description}}</div>
                        {{/if}}
                      </div>
                      <div class="backup-actions">
                        <button type="button" class="restore-backup-btn"
                                data-backup-id="{{this.id}}"
                                data-backup-name="{{this.name}}"
                                title="{{localize 'LOREMASTER.Backup.RestoreBackup'}}">
                          <i class="fas fa-undo"></i>
                        </button>
                        <button type="button" class="delete-backup-btn"
                                data-backup-id="{{this.id}}"
                                data-backup-name="{{this.name}}"
                                title="{{localize 'LOREMASTER.Backup.DeleteBackup'}}">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </li>
                  {{/each}}
                </ul>
              {{else}}
                <div class="no-backups-state">
                  <i class="fas fa-box-open"></i>
                  <p>{{localize "LOREMASTER.Backup.NoSavedBackups"}}</p>
                </div>
              {{/if}}
            </section>
          {{/if}}

          {{!-- Import Section --}}
          <section class="backup-section import-section">
            <h3><i class="fas fa-upload"></i> {{localize "LOREMASTER.Backup.ImportTitle"}}</h3>
            <p class="section-description">
              {{localize "LOREMASTER.Backup.ImportDescription"}}
            </p>

            {{#unless pendingImport}}
              <div class="import-controls">
                <div class="file-drop-zone" id="backup-drop-zone">
                  <i class="fas fa-file-import"></i>
                  <p>{{localize "LOREMASTER.Backup.DropZoneText"}}</p>
                  <input type="file" class="backup-file-input" accept=".json" style="display: none;">
                </div>
              </div>
            {{/unless}}

            {{#if pendingImport}}
              <div class="import-preview">
                <h4>{{localize "LOREMASTER.Backup.BackupContents"}}</h4>
                <div class="import-meta">
                  <p><strong>{{localize "LOREMASTER.Backup.World"}}:</strong> {{pendingImport.worldName}}</p>
                  <p><strong>{{localize "LOREMASTER.Backup.System"}}:</strong> {{pendingImport.systemTitle}}</p>
                  <p><strong>{{localize "LOREMASTER.Backup.Exported"}}:</strong> {{pendingImport.exportedAt}}</p>
                </div>
                <ul class="preview-list">
                  <li>{{pendingImport.canon.length}} {{localize "LOREMASTER.Backup.CanonEntries"}}</li>
                  <li>{{pendingImport.houseRules.length}} {{localize "LOREMASTER.Backup.HouseRules"}}</li>
                  <li>{{pendingImport.gmPrepScripts.length}} {{localize "LOREMASTER.Backup.GMPrepScripts"}}</li>
                  {{#if pendingImport.conversationSummaries}}
                    <li>{{pendingImport.conversationSummaries.length}} {{localize "LOREMASTER.Backup.ConversationSummaries"}}</li>
                  {{/if}}
                </ul>

                <div class="import-options">
                  <label>
                    <input type="checkbox" name="overwrite" checked>
                    {{localize "LOREMASTER.Backup.OverwriteExisting"}}
                  </label>
                  <label>
                    <input type="checkbox" name="merge">
                    {{localize "LOREMASTER.Backup.MergeWithExisting"}}
                  </label>
                </div>

                <div class="import-actions">
                  <button class="cancel-import-btn">
                    <i class="fas fa-times"></i> {{localize "LOREMASTER.Backup.Cancel"}}
                  </button>
                  <button class="confirm-import-btn" {{#if isImportingBackup}}disabled{{/if}}>
                    <i class="fas fa-check"></i> {{localize "LOREMASTER.Backup.ImportBackup"}}
                  </button>
                </div>
              </div>
            {{/if}}

            {{#if isImportingBackup}}
              <div class="progress-container import-progress">
                <div class="progress-bar import-progress-bar" style="width: {{importProgress.progress}}%"></div>
                <span class="progress-text import-progress-text">{{importProgress.message}}</span>
              </div>
            {{/if}}
          </section>

          {{!-- Info Section --}}
          <section class="backup-section info-section">
            <h3><i class="fas fa-info-circle"></i> {{localize "LOREMASTER.Backup.WhatsIncluded"}}</h3>
            <div class="info-grid">
              <div class="info-item included">
                <i class="fas fa-check-circle"></i>
                <div>
                  <strong>{{localize "LOREMASTER.Backup.Included"}}:</strong>
                  {{localize "LOREMASTER.Backup.IncludedList"}}
                </div>
              </div>
              <div class="info-item not-included">
                <i class="fas fa-times-circle"></i>
                <div>
                  <strong>{{localize "LOREMASTER.Backup.NotIncluded"}}:</strong>
                  {{localize "LOREMASTER.Backup.NotIncludedList"}}
                </div>
              </div>
            </div>
          </section>
        </div>
      {{else}}
        <div class="permission-notice">
          <i class="fas fa-lock"></i>
          <p>{{localize "LOREMASTER.Backup.GMOnly"}}</p>
        </div>
      {{/if}}
    </div>
  </section>
</div>
